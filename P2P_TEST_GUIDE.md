# P2P 통신 테스트 가이드

## 개요
이 가이드는 2개 이상의 앱 인스턴스를 실행하여 P2P 메시징 기능을 테스트하는 방법을 설명합니다.

## 사전 준비

### 1. 개발 서버 실행
터미널 1에서:
```bash
pnpm dev:web
```

이 명령어는 Vite 개발 서버를 http://localhost:5173 또는 5174에서 실행합니다.

## 인스턴스 실행 방법

### 방법 1: 개발 모드에서 실행 (권장)

#### 인스턴스 1 실행
터미널 2에서:
```bash
pnpm tauri dev
```

#### 인스턴스 2 실행
터미널 3에서:
```bash
cargo run --manifest-path=src-tauri/Cargo.toml
```

또는 빌드된 실행파일을 직접 실행:
```bash
./src-tauri/target/debug/edulinker_messenger_tauri.exe
```

### 방법 2: 빌드된 실행파일 직접 실행

두 개의 명령 프롬프트나 PowerShell 창을 열고:

**창 1:**
```bash
cd src-tauri/target/debug
./edulinker_messenger_tauri.exe
```

**창 2:**
```bash
cd src-tauri/target/debug
./edulinker_messenger_tauri.exe
```

## 테스트 사용자 설정

### 자동 로그인 사용 (로컬 모드)

각 인스턴스에서:

1. 앱이 시작되면 로그인 페이지가 표시됩니다
2. 개발자 도구를 열려면:
   - 우측 하단의 개발 FAB 버튼 클릭
   - 또는 단축키 (설정되어 있다면)

3. 개발자 사이드바에서:
   - **인스턴스 1**: "교사로 자동 로그인" 또는 "관리자로 자동 로그인" 클릭
   - **인스턴스 2**: 다른 역할로 자동 로그인 (예: 인스턴스1이 교사면, 인스턴스2는 관리자)

### 수동 로그인 (서버 모드)

각 인스턴스에서 다른 계정으로 로그인:

**인스턴스 1:**
- 이메일: teacher1@school.com
- 비밀번호: (테스트 비밀번호)

**인스턴스 2:**
- 이메일: teacher2@school.com
- 비밀번호: (테스트 비밀번호)

## P2P 통신 테스트 절차

### 1. P2P 서비스 시작 확인

각 인스턴스에서:
1. 대시보드로 이동
2. "메시지함" 탭 클릭
3. 우측 상단의 P2P 상태 확인:
   - 🟢 초록색 점: P2P 실행 중
   - 🔴 회색 점: P2P 대기 중
4. IP 주소가 표시되는지 확인

### 2. 피어 발견 확인

- 좌측 연락처 목록에서 다른 인스턴스의 사용자가 표시되는지 확인
- 온라인 상태 (🟢)가 표시되는지 확인
- 피어 카운트가 증가하는지 확인 (예: "P2P (1)")

### 3. 메시지 전송 테스트

**인스턴스 1에서:**
1. 연락처 목록에서 인스턴스 2의 사용자 클릭
2. 메시지 입력창에 텍스트 입력
3. "전송" 버튼 클릭
4. 메시지가 전송 상태 표시와 함께 나타나는지 확인 (✓ 표시)

**인스턴스 2에서:**
1. 새 메시지 알림 확인
2. 메시지 내용이 정확히 수신되었는지 확인
3. 답장 전송

### 4. 파일 전송 테스트

**인스턴스 1에서:**
1. 대화창에서 파일 첨부 버튼 (📎) 클릭
2. 테스트 파일 선택 (이미지, 문서 등)
3. 메시지와 함께 전송
4. 전송 진행률 확인

**인스�an스 2에서:**
1. 파일 전송 요청 다이얼로그 표시 확인
2. "수락" 버튼 클릭
3. 파일 수신 진행률 확인
4. 수신 완료 후 파일 다운로드 폴더 확인

### 5. 타이핑 인디케이터 테스트

**인스턴스 1에서:**
1. 메시지 입력창에 타이핑 시작

**인스턴스 2에서:**
1. 대화 헤더에 "입력 중..." 표시 확인
2. 타이핑을 멈추면 사라지는지 확인

### 6. 읽음 확인 테스트

**인스턴스 1에서:**
1. 메시지 전송
2. 전달 확인 (✓) 표시 확인

**인스턴스 2에서:**
1. 메시지 확인

**인스턴스 1에서:**
1. 읽음 확인 (✓✓) 표시로 변경되는지 확인

## 네트워크 환경 시뮬레이션

### 같은 PC에서 테스트
- 기본적으로 localhost (127.0.0.1)로 통신
- 별도 설정 불필요

### 다른 PC에서 테스트 (LAN)
1. 두 PC가 같은 네트워크에 연결되어 있는지 확인
2. 방화벽에서 앱의 포트 허용:
   - UDP: 디스커버리 포트 (기본: 54321)
   - TCP: 메시지 전송 포트 (동적 할당)
3. 각 PC에서 앱 실행
4. 네트워크 디스커버리가 자동으로 피어 찾기 시작

### 포트 충돌 해결
만약 같은 PC에서 여러 인스턴스 실행 시 포트 충돌이 발생하면:

1. 서버 포트는 자동으로 다음 사용 가능한 포트 할당
2. 콘솔 로그에서 각 인스턴스의 포트 확인
3. P2P 디스커버리는 브로드캐스트를 사용하므로 포트 충돌 없음

## 디버깅

### 콘솔 로그 확인

**브라우저 개발자 도구:**
- Windows: F12 또는 Ctrl+Shift+I
- 로그 필터: `[MessagingPanel]`, `[P2P]`, `[InternalP2P]`

**주요 로그 메시지:**
```
[MessagingPanel] P2P service started
[MessagingPanel] Peer discovered: { userId, userName, ipAddress }
[MessagingPanel] P2P message received
[MessagingPanel] P2P 메시지 전송 성공
```

### 연결 문제 해결

**증상: 피어가 발견되지 않음**
- P2P 상태가 "실행 중"인지 확인
- 방화벽 설정 확인
- 네트워크 연결 확인
- 같은 schoolId로 로그인했는지 확인

**증상: 메시지가 전송되지 않음**
- 수신자가 온라인 상태인지 확인
- 네트워크 연결 확인
- 콘솔에서 에러 메시지 확인

**증상: 파일이 전송되지 않음**
- P2P가 활성화되어 있는지 확인
- 다운로드 폴더가 설정되어 있는지 확인
- 파일 크기 제한 확인

## 테스트 체크리스트

- [ ] 두 인스턴스 모두 실행됨
- [ ] 각 인스턴스에서 다른 사용자로 로그인
- [ ] P2P 서비스 시작됨 (초록색 표시)
- [ ] 피어 발견됨 (연락처 목록에 표시)
- [ ] 텍스트 메시지 양방향 전송 성공
- [ ] 파일 전송 성공
- [ ] 타이핑 인디케이터 작동
- [ ] 읽음 확인 작동
- [ ] 온라인/오프라인 상태 동기화

## 성능 테스트

### 메시지 처리량
- 연속으로 10개 메시지 전송
- 모든 메시지가 순서대로 수신되는지 확인
- 지연 시간 측정

### 파일 전송 속도
- 큰 파일 (10MB 이상) 전송
- 진행률 업데이트 확인
- 전송 시간 측정

### 동시 연결
- 3개 이상의 인스턴스 실행
- 모든 피어가 서로 발견되는지 확인
- 그룹 메시지 기능 테스트 (구현된 경우)

## 문제 보고

테스트 중 발견된 문제는 다음 정보와 함께 보고:
- 문제 설명
- 재현 단계
- 예상 동작 vs 실제 동작
- 콘솔 로그
- 스크린샷 (가능한 경우)
- 네트워크 환경 (같은 PC, LAN, 인터넷)
